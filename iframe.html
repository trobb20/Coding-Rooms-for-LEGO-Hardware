<html>

    <head>
        <script type="text/javascript" src="./modules/ServiceDock_SPIKE.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"
            integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg=="
            crossorigin="anonymous"></script>
        <script language="javascript">

            var motorInfo = '<div id="motor" style="background-color: lightblue; width: 70px; height:70px;">Motor<div id="motorAngle"></div></div>'
            var colorInfo = '<div id="color" style="background-color: lightblue; width: 70px; height:70px;">Color<div id="colorRGBbox" data-r="0", data-g="0", data-b="0" style="height:30px;width:30px;"> </div> </div>';
            var distanceInfo = '<div id="distance" style="background-color: lightblue; width: 70px; height:70px;">Distance<div id = "distanceValue"></div></div>';
            var forceInfo = '<div id="force" style="background-color: lightblue; width: 70px; height:70px;">Force<div id="forceForce"></div></div>';

            // SPIKE Prime Code
            var mySPIKE;
            var hubProjects;
            var devicesInfo = document.getElementById("devicesInfo");

            window.onload = function () {
                console.log("here!");

                mySPIKE = document.getElementById("Service_SPIKE").getService();

                var refreshButton = document.getElementById("refresh");
                refreshButton.addEventListener("click", function () {
                    document.location.reload();
                })
                
                mySPIKE.executeAfterInit(async function () {
                    
                    hubProjects = await mySPIKE.getProjects();
                    
                    for ( var slot in hubProjects ) {
                        var slotOption = document.getElementById("slot" + slot);

                        if (hubProjects[slot] != "None") {
                            slotOption.innerHTML = "(" + slot + ") " + hubProjects[slot]["name"];
                        }
                        else {
                            slotOption.innerHTML = "(" + slot + ") " + "None";
                        }
                    }

                    var runButton = document.getElementById("runProgram");
                    runButton.addEventListener("click", function () {

                        var slotidSelect = document.getElementById("slotidSelect");
                        var slotidOption = slotidSelect.options[slotidSelect.selectedIndex];
                        var slotid = slotidOption.id;
                        slotid = slotid.substring(4, slotid.length);

                        var slotidInteger = parseInt(slotid);

                        mySPIKE.executeProgram(slotidInteger);
                    })

                    var rebootButton = document.getElementById("rebootHub");
                    rebootButton.addEventListener("click", function () {
                        mySPIKE.rebootHub();
                    })

                    var stopButton = document.getElementById("stopProgram");
                    stopButton.addEventListener("click", function () {
                        mySPIKE.stopCurrentProgram();
                    })

                    mySPIKE.executeAfterPrint(funcAfterPrint);

                    function funcAfterPrint(message) {
                        var consoleText = document.getElementById("console");
                        consoleText.value = consoleText.value + "\r\n" + message;
                    }
                    
                    setInterval( async function () {

                        var batteryStatus = await mySPIKE.getBatteryStatus();

                        var batteryInfo = document.getElementById("batteryInfo");
                        batteryInfo.innerHTML = "Battery: " + batteryStatus + "%";

                        var portsInfo = await mySPIKE.getPortsInfo();
                        
                        for ( var port in portsInfo ) {

                            if (portsInfo[port]["device"] == "smallMotor" || portsInfo[port]["device"] == "bigMotor") {
                                var motorDiv = await addMotorIcon(port);
                                var motorAngleDiv = motorDiv.querySelector("#motorAngle");
                                motorAngleDiv.innerHTML = portsInfo[port]["data"]["uAngle"] + '&deg;';
                            }
                            else if (portsInfo[port]["device"] == "color") {
                                var colorDiv = await addColorIcon(port);
                                var RGBbox = colorDiv.querySelector("#colorRGBbox");
                                var R = portsInfo[port]["data"]["RGB"][0];
                                var G = portsInfo[port]["data"]["RGB"][1];
                                var B = portsInfo[port]["data"]["RGB"][2];
                                RGBbox.style.backgroundColor = "rgb(" + R +"," + G + "," + B + ")";
                            }
                            else if (portsInfo[port]["device"] == "ultrasonic") {
                                var distanceDiv = await addDistanceIcon(port);
                                var distanceValueDiv = distanceDiv.querySelector("#distanceValue");
                                distanceValueDiv.innerHTML = portsInfo[port]["data"]["distance"] + " cm";
                            }
                            else if (portsInfo[port]["device"] == "force") {
                                var forceDiv = await addForceIcon(port);
                                var forceForceDiv = forceDiv.querySelector("#forceForce");
                                forceForceDiv.innerHTML = portsInfo[port]["data"]["force"] + " N";
                            }
                            else {
                                var portDiv = document.getElementById("port" + port + "Info");
                                portDiv.style.display = "none";
                                portDiv.innerHTML = "";
                            }
                        }


                    }, 100)

                })
                console.log("mySPIKE = " + mySPIKE);
            };

            function addMotorIcon(port) {
                var portInfo = document.getElementById("port" + port + "Info");
                portInfo.style.display = "block";
                portInfo.innerHTML = motorInfo;
                var motorDiv = portInfo.querySelector("#motor");

                return motorDiv;
            }

            function addDistanceIcon(port) {
                var portInfo = document.getElementById("port" + port + "Info");
                portInfo.style.display = "block";
                portInfo.innerHTML = distanceInfo;
                var distanceDiv = portInfo.querySelector("#distance");

                return distanceDiv;
            }

            function addColorIcon(port) {
                var portInfo = document.getElementById("port" + port + "Info");
                portInfo.style.display = "block";
                portInfo.innerHTML = colorInfo;
                var colorDiv = portInfo.querySelector("#color");

                return colorDiv;
            }

            function addForceIcon(port) {
                var portInfo = document.getElementById("port" + port + "Info");
                portInfo.style.display = "block";
                portInfo.innerHTML = forceInfo;
                var forceDiv = portInfo.querySelector("#force");

                return forceDiv;
            }

            requirejs.config({
                paths: {
                    'cc-web-exec-client': 'https://unpkg.com/@exlinc/cc-web-exec-sdk@1.0.6/dist/cc-web-exec-sdk'
                },
            });

            requirejs(['cc-web-exec-client'],
                function (webExecSDK) {
                    window.webExecClient = new webExecSDK.CCWebExecClient();
                    initApp();
                }
            );

            function initApp() {
                // NOTE: the subscribe call returns a string id for this subscriber that can be passed to the
                //       unsubscribe function to drop this particular subscriber. This is not necessary if you call
                //       the `.dispose()` function or you plan to have your app 'disposed' automatically when the iframe
                //       is removed by the parent.
                window.webExecClient.subscribe('execute_code', function (event, payload) {
                    console.log(event, payload);
                    writeCodeExecRequestPayloadToDOM(payload);
                });
            }

            async function writeCodeExecRequestPayloadToDOM(payload) {
                // var files = payload.files;
                // for (var key in files) {
                //     if (files.hasOwnProperty(key)) {
                //         document.getElementById("mycontent").innerHTML += "<b>File:</b> " + key + "<br />\n";
                //         document.getElementById("mycontent").innerHTML += "<b>Code:</b><br />\n";
                //         document.getElementById("mycontent").innerHTML += "<blockquote style=\"font-family:'Courier New', Courier\">" + files[key] + "</blockquote>\n";
                //         mySPIKE.sendDATA(files[key]);
                //     }
                // }
                var files = payload.files;
                // assumes there is only one key-value pair in files
                for ( var key in files ) {
                    console.log("key: ", key);
                    var fileName = key;    
                    var fileContent = files[key];
                    
                    console.log("fileContent: ", fileContent);
                }

                var slotidSelect = document.getElementById("slotidSelect");
                var slotidOption = slotidSelect.options[slotidSelect.selectedIndex];
                var slotid = slotidOption.id;
                slotid = slotid.substring(4, slotid.length);

                var slotidInteger = parseInt(slotid);

                // register the program into SPIKE
                mySPIKE.writeProgram(fileName, fileContent, slotidInteger, async function () {
                    // show the new list of programs currently registered in the SPIKE

                    var hubProjects = await mySPIKE.getProjects();

                    for (var slot in hubProjects) {
                        var slotOption = document.getElementById("slot" + slot);

                        if (hubProjects[slot] != "None") {
                            slotOption.innerHTML = "(" + slot + ") " + hubProjects[slot]["name"];
                        }
                        else {
                            slotOption.innerHTML = "(" + slot + ") " + "None";
                        }
                    }

                    // execute the program that was just downloaded
                    mySPIKE.executeProgram(slotidInteger);

                });

                return true;
            }

        </script>
    </head>

    <body>
        <div id="servicedock" style="position: absolute; top:10px; right:10px;">
            <service-spike id="Service_SPIKE"></service-spike>
        </div>
        <input type="button" style = "position: absolute; background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABmJLR0QA/wD/AP+gvaeTAAABDUlEQVRIie2VMQ7CMAxFH0iwACMjF6ADEgucggtwCU4CokfgDExwDJhYu3YChg6IMsSWqtA2CdCNL1mOGts/be0f+CMQQzHFCEiB3LI7cAY2QORbvAXsxVqF5wvgWUKi9gBioOsiWBWSVo7YHjADtkAmOcc6kmkhMJf11HUiwQRIJC8uCxgAF95f/SJ7viQZ5nON7c1dSXG1nScBcvocWNcFaeFPMJPcU1MEfcm9NkVQmt/+opgXbIKb+H5TBIn4t1b7FcFB/DKgRrHNFZVtHmGGJcMMjw+CB1UHJgkgCZKaDka4NDAG5rh/fIhY0pXCD6pl5ImRckWV3NciwmjLCdPCNkmKuZQU9oX1hxsv9ntsmYmYPLAAAAAASUVORK5CYII=')no-repeat; background-size: 20px 20px; background-position: center; height: 24px; width: 24px;  cursor: pointer;" id = "refresh">
        <h1 align = center >SPIKE Prime Web UI</h1>
        <div id = "topbar">
            <div style="float:left">
                Slot:
            </div>
            <select id="slotidSelect" style="float:left">
                <option id="slot0">0</option>
                <option id="slot1">1</option>
                <option id="slot2">2</option>
                <option id="slot3">3</option>
                <option id="slot4">4</option>
                <option id="slot5">5</option>
                <option id="slot6">6</option>
                <option id="slot7">7</option>
                <option id="slot8">8</option>
                <option id="slot9">9</option>
                <option id="slot10">10</option>
                <option id="slot11">11</option>
                <option id="slot12">12</option>
                <option id="slot13">13</option>
                <option id="slot14">14</option>
                <option id="slot15">15</option>
                <option id="slot16">16</option>
                <option id="slot17">17</option>
                <option id="slot18">18</option>
                <option id="slot19">19</option>
            </select>
            <input type = "submit" id = "runProgram" value = "Execute">
            <input type="submit" id="rebootHub" value="Reboot">
            <input type="submit" id = "stopProgram" value="Stop">
        </div>
        <br />
        <div id = "telemetry">
            <div>
                Console
            </div>
            <textarea id = "console" readonly style = "width: 500px; height: 100px; white-space:pre-wrap"></textarea>
        </div>
        <br/>
        <div id = "devicesInfo">
            <div id = "portAInfo" style = "float:left; margin: 2px;">
                <div id="motor" style="background-color: lightblue; width: 70px; height:70px;">
                    Motor
                    <div id="motorAngle">
                    </div>
                </div>
            </div>
            <div id = "portBInfo" style = "float:left; margin: 2px;">
                <div id="color" style="background-color: lightblue; width: 70px; height:70px;">
                    Color
                    <div id="colorRGBbox" data-r="0", data-g="0", data-b="0" style="height:30px;width:30px;"> </div> 
                </div>
            </div>
            <div id = "portCInfo" style = "float:left; margin: 2px;">
                <div id="ultrasonic" style="background-color: lightblue; width: 70px; height:70px;">
                    Distance
                    <div id = "ultrasonicDistance">
                    </div>
                </div>
            </div> 
            <div id = "portDInfo" style = "float:left; margin: 2px;">
                <div id="force" style="background-color: lightblue; width: 70px; height:70px;">
                    Force
                    <div id="forceForce">
                    </div>
                </div>
            </div> 
            <div id = "portEInfo" style = "float:left; margin: 2px;"></div> 
            <div id = "portFInfo" style = "float:left; margin: 2px;"></div>

        </div>
        <br/><br /><br /><br /><br />
        <div id = "SPIKEInfo">
            <div id = "batteryInfo">

            </div>
        </div>
    </body>

</html>